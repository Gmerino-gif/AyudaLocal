import express from "express";
import cookieParser from 'cookie-parser';
import path from 'path';
import { fileURLToPath } from 'url';
const __dirname = path.dirname(fileURLToPath(import.meta.url));
import { methods as authentication } from "app_vieja/controllers/authentication.controller.js";
import { methods as authorization } from "app_vieja/controllers/middlewares/authorization.js";
import fs from 'fs/promises';

// Server
const app = express();
app.set("port", 4000);
app.listen(app.get("port"));
console.log("Servidor corriendo en puerto", app.get("port"));

// Configuración
app.use(express.static(__dirname + "/public"));
app.use(express.json());
app.use(cookieParser());

// Rutas existentes
app.get("/", authorization.soloPublico, (req, res) => res.sendFile(__dirname + "/pages/index.html"));
app.get("/login.html", authorization.soloPublico, (req, res) => res.sendFile(__dirname + "/pages/login.html"));
app.get("/register.html", authorization.soloPublico, (req, res) => res.sendFile(__dirname + "/pages/register.html"));
app.get("/admin.html", authorization.soloAdmin, (req, res) => res.sendFile(__dirname + "/pages/admin/admin.html"));
app.get("/dashboard.html", authorization.soloAdmin, (req, res) => res.sendFile(__dirname + "/pages/admin/dashboard.html"));
app.post("/api/login", authentication.login);
app.post("/api/register", authentication.register);

// Nuevas rutas para manejo de formularios
app.post("/api/solicitudes", authorization.soloAdmin, async (req, res) => {
    try {
        const nuevaSolicitud = req.body;
        const filePath = path.join(__dirname, 'data', 'solicitudes.json');
        
        // Crear directorio si no existe
        await fs.mkdir(path.dirname(filePath), { recursive: true });
        
        // Leer archivo existente o crear uno nuevo
        let solicitudes = [];
        try {
            const data = await fs.readFile(filePath, 'utf-8');
            solicitudes = JSON.parse(data);
        } catch (err) {
            if (err.code !== 'ENOENT') throw err;
        }
        
        // Agregar fecha y ID
        nuevaSolicitud.fecha = new Date().toISOString();
        nuevaSolicitud.id = Date.now().toString();
        
        // Agregar nueva solicitud
        solicitudes.push(nuevaSolicitud);
        
        // Guardar en archivo
        await fs.writeFile(filePath, JSON.stringify(solicitudes, null, 2));
        
        res.status(201).json({ 
            success: true,
            message: "Solicitud guardada exitosamente",
            id: nuevaSolicitud.id
        });
    } catch (error) {
        console.error("Error al guardar solicitud:", error);
        res.status(500).json({ 
            success: false,
            message: "Error al procesar la solicitud"
        });
    }
});

app.post("/api/donaciones", authorization.soloAdmin, async (req, res) => {
    try {
        const nuevaDonacion = req.body;
        const filePath = path.join(__dirname, 'data', 'donaciones.json');
        
        // Crear directorio si no existe
        await fs.mkdir(path.dirname(filePath), { recursive: true });
        
        // Leer archivo existente o crear uno nuevo
        let donaciones = [];
        try {
            const data = await fs.readFile(filePath, 'utf-8');
            donaciones = JSON.parse(data);
        } catch (err) {
            if (err.code !== 'ENOENT') throw err;
        }
        
        // Agregar fecha y ID
        nuevaDonacion.fecha = new Date().toISOString();
        nuevaDonacion.id = Date.now().toString();
        
        // Agregar nueva donación
        donaciones.push(nuevaDonacion);
        
        // Guardar en archivo
        await fs.writeFile(filePath, JSON.stringify(donaciones, null, 2));
        
        res.status(201).json({ 
            success: true,
            message: "Donación registrada exitosamente",
            id: nuevaDonacion.id
        });
    } catch (error) {
        console.error("Error al registrar donación:", error);
        res.status(500).json({ 
            success: false,
            message: "Error al procesar la donación"
        });
    }
});

// Ruta para obtener solicitudes (opcional)
app.get("/api/solicitudes", authorization.soloAdmin, async (req, res) => {
    try {
        const filePath = path.join(__dirname, 'data', 'solicitudes.json');
        const data = await fs.readFile(filePath, 'utf-8');
        res.json(JSON.parse(data));
    } catch (error) {
        if (error.code === 'ENOENT') {
            res.json([]);
        } else {
            res.status(500).json({ error: "Error al leer las solicitudes" });
        }
    }
});

// Ruta para obtener donaciones (opcional)
app.get("/api/donaciones", authorization.soloAdmin, async (req, res) => {
    try {
        const filePath = path.join(__dirname, 'data', 'donaciones.json');
        const data = await fs.readFile(filePath, 'utf-8');
        res.json(JSON.parse(data));
    } catch (error) {
        if (error.code === 'ENOENT') {
            res.json([]);
        } else {
            res.status(500).json({ error: "Error al leer las donaciones" });
        }
    }
});



